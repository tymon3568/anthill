# Task: Create Removal Strategies Table (Multi-Tenant)

**Task ID:** `PROJECT_TRACKING/V1_MVP/04_Inventory_Service/4.2_Warehouse_Management/task_04.02.05_create_removal_strategies_table.md`  
**Status:** Todo  
**Priority:** P1  
**Assignee:**  
**Last Updated:** 2025-12-28  
**Phase:** V1_MVP  
**Module:** 04_Inventory_Service â†’ 4.2_Warehouse_Management  
**Dependencies:**  
- `PROJECT_TRACKING/V1_MVP/04_Inventory_Service/4.2_Warehouse_Management/task_04.02.01_create_warehouse_hierarchy_api.md` (must be Done)

## Context
Per `docs/INVENTORY_IMPROVE.md`, Anthill needs configurable removal strategies similar to Odoo (FIFO/LIFO/FEFO/Closest). Today the system relies mainly on FEFO logic, which is insufficient for real WMS scenarios and blocks advanced picking methods.

This task is **schema-only** (DB tables + constraints + indexes). Service/API wiring and algorithm changes should be implemented in follow-up tasks (e.g., `4.10_Advanced_Warehouse/task_04.10.03_implement_removal_strategies.md`).

## Goal
Introduce tenant-scoped configuration tables that allow selecting a removal strategy at different scopes (tenant default / warehouse / location / product category / product), with clear precedence and performant lookups.

## Scope
### In scope
- Create tables:
  - `removal_strategies` (catalog/config per tenant)
  - `removal_strategy_assignments` (assignment by scope with priority)
- Enforce strict multi-tenancy:
  - every table includes `tenant_id UUID NOT NULL`
  - composite keys and indexes include `(tenant_id, ...)`
  - composite foreign keys include `tenant_id` where referencing tenant-scoped tables
- Add constraints and indexes for common resolution queries.

### Out of scope
- API endpoints and CRUD
- Picking algorithm implementation (FIFO/LIFO/Closest logic)
- UI
- Postgres RLS (we use application filtering)

## Proposed Data Model (Draft)

### 1) `removal_strategies`
Represents a strategy type and tenant-level configuration.

**Columns (suggested):**
- `tenant_id UUID NOT NULL`
- `removal_strategy_id UUID NOT NULL` (UUID v7 generated by application)
- `code TEXT NOT NULL` (e.g., `FIFO`, `LIFO`, `FEFO`, `CLOSEST`)
- `name TEXT NOT NULL`
- `description TEXT NULL`
- `is_active BOOLEAN NOT NULL DEFAULT TRUE`
- `deleted_at TIMESTAMPTZ NULL` (optional, if soft delete is used)
- `created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()`
- `updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()`

**Constraints (suggested):**
- Primary key: `(tenant_id, removal_strategy_id)`
- Unique: `(tenant_id, code)` to avoid duplicates per tenant

**Indexes (suggested):**
- `(tenant_id, code)`
- Optional partial active lookup if using soft delete:
  - `(tenant_id, code) WHERE deleted_at IS NULL AND is_active = TRUE`

### 2) `removal_strategy_assignments`
Defines which strategy applies to which scope.

**Scope precedence (suggested, not enforced here):**
`product` > `product_category` > `location` > `warehouse` > `tenant default`

**Columns (suggested):**
- `tenant_id UUID NOT NULL`
- `assignment_id UUID NOT NULL` (UUID v7 generated by application)
- `removal_strategy_id UUID NOT NULL`
- `warehouse_id UUID NULL`
- `location_id UUID NULL`
- `product_category_id UUID NULL`
- `product_id UUID NULL`
- `priority INT NOT NULL DEFAULT 100` (lower number = higher priority)
- `effective_from TIMESTAMPTZ NULL`
- `effective_to TIMESTAMPTZ NULL`
- `deleted_at TIMESTAMPTZ NULL` (optional)
- `created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()`
- `updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()`

**Foreign keys (MUST include tenant_id in composite FKs):**
- `(tenant_id, removal_strategy_id) -> removal_strategies(tenant_id, removal_strategy_id)`
- `(tenant_id, warehouse_id) -> warehouses(tenant_id, warehouse_id)` (if table exists)
- `(tenant_id, location_id) -> warehouse_locations(tenant_id, location_id)` (or actual locations table)
- `(tenant_id, product_category_id) -> product_categories(tenant_id, product_category_id)` (if table exists)
- `(tenant_id, product_id) -> products(tenant_id, product_id)`

**Constraints (suggested):**
- Allow tenant default assignment by permitting all scope columns to be NULL, OR enforce at least one scope (choose and document).
- Optional: prevent contradictory combinations (depends on existing warehouse model).

**Indexes (suggested):**
- `(tenant_id, product_id, priority)`
- `(tenant_id, product_category_id, priority)`
- `(tenant_id, location_id, priority)`
- `(tenant_id, warehouse_id, priority)`
- Optional partial variants with `WHERE deleted_at IS NULL`

## Specific Sub-tasks (Style B)

### A) Task initialization (folder-tasks required)
- [ ] Verify dependency status is `Done`:
  - [ ] `task_04.02.01_create_warehouse_hierarchy_api.md`
- [ ] Update this task header before implementation:
  - [ ] `Status: InProgress_By_[AgentName]`
  - [ ] `Assignee: [AgentName]`
  - [ ] `Last Updated: YYYY-MM-DD`
- [ ] Add AI Agent Log entry stating dependency check results.

### B) DB schema + constraints (multi-tenant)
- [ ] Scan existing schema to confirm correct referenced table names/PKs for:
  - [ ] warehouses (or warehouse root representation)
  - [ ] locations (warehouse locations table)
  - [ ] products / categories tables
- [ ] Draft SQL migration(s) to create `removal_strategies`:
  - [ ] `tenant_id UUID NOT NULL`
  - [ ] composite PK `(tenant_id, removal_strategy_id)`
  - [ ] unique `(tenant_id, code)`
  - [ ] timestamps `created_at/updated_at` as `TIMESTAMPTZ`
  - [ ] optional `deleted_at` (only if consistent with config tables in repo)
- [ ] Draft SQL migration(s) to create `removal_strategy_assignments`:
  - [ ] composite PK includes `tenant_id`
  - [ ] composite FK to `removal_strategies(tenant_id, removal_strategy_id)`
  - [ ] composite FK(s) to warehouses/locations/products/categories where applicable
  - [ ] add scope+priority indexes for resolution queries
- [ ] Decide and document (in migration comments) whether tenant-default assignment is allowed (all NULL scopes) and how precedence will be resolved in code later.

### C) Core/Infra/API
- [ ] Confirm this task remains **schema-only**:
  - [ ] Do not add service traits, repos, or API handlers here (those belong to `4.10_*` tasks).
  - [ ] If minimal repo scaffolding is required by project conventions, keep it strictly infra-only and tenant-filtered.

### D) Validation
- [ ] Run migrations locally (`sqlx migrate run`) and verify:
  - [ ] tables exist
  - [ ] composite keys include `tenant_id`
  - [ ] indexes exist and match intended lookup patterns
  - [ ] foreign keys do not allow cross-tenant references
- [ ] Add a brief note in AI Agent Log listing:
  - [ ] actual referenced table names used for FKs
  - [ ] any deviations from the proposed model

### E) Quality gates (before NeedsReview)
- [ ] `cargo fmt`
- [ ] `cargo check --workspace`
- [ ] `cargo clippy --workspace -- -D warnings` (or project policy)
- [ ] `cargo test --workspace` (if applicable)

## Acceptance Criteria
- [ ] Migration(s) exist creating `removal_strategies` and `removal_strategy_assignments`.
- [ ] All tenant-scoped tables include `tenant_id UUID NOT NULL`.
- [ ] All keys/indexes are tenant-aware (composite with `tenant_id`).
- [ ] Composite FKs include `tenant_id` for tenant-scoped targets.
- [ ] No RLS introduced.
- [ ] Migration applies cleanly on a fresh/dev database.
- [ ] Task uses a checkbox-based sub-task list and can be executed sequentially.

## AI Agent Log
---
* 2025-12-28 00:00: Task created (schema planning) by AI
  - Expanded task to folder-tasks Style B checklist with normalized metadata header.
  - Status: Todo
  - Files modified: `PROJECT_TRACKING/V1_MVP/04_Inventory_Service/4.2_Warehouse_Management/task_04.02.05_create_removal_strategies_table.md`
---
