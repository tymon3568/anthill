# API Gateway Routing Rules
# Routes requests to appropriate microservices based on path patterns

# Map for environment-based routing
map $http_x_environment $docs_allowed {
    development 1;
    default 0;
}

# Rate limiting for API endpoints
limit_req zone=api burst=20 nodelay;

# User Service Routes (/api/v1/auth/*, /api/v1/users/*)
location ~ ^/api/v1/(auth|users|admin/users|admin/roles|admin/permissions) {
    # Stricter rate limiting for auth endpoints
    limit_req zone=auth burst=5 nodelay;

    # Proxy to user service
    proxy_pass http://user_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Tenant context headers (extract from subdomain or header)
    proxy_set_header X-Tenant-ID $http_x_tenant_id;
    proxy_set_header X-Tenant-Slug $http_x_tenant_slug;

    # Security headers
    proxy_set_header X-Request-ID $request_id;

    # Timeout settings
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    # Buffer settings for large responses
    proxy_buffering on;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
}

# Inventory Service Routes (/api/v1/products/*, /api/v1/inventory/*)
location ~ ^/api/v1/(products|inventory|categories|suppliers) {
    # Tenant-based rate limiting
    limit_req zone=tenant burst=50 nodelay;

    proxy_pass http://inventory_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Tenant-ID $http_x_tenant_id;
    proxy_set_header X-Tenant-Slug $http_x_tenant_slug;
    proxy_set_header X-Request-ID $request_id;

    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Order Service Routes (/api/v1/orders/*, /api/v1/cart/*)
location ~ ^/api/v1/(orders|cart|shipments) {
    limit_req zone=tenant burst=30 nodelay;

    proxy_pass http://order_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Tenant-ID $http_x_tenant_id;
    proxy_set_header X-Tenant-Slug $http_x_tenant_slug;
    proxy_set_header X-Request-ID $request_id;

    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Payment Service Routes (/api/v1/payments/*, /api/v1/billing/*)
location ~ ^/api/v1/(payments|billing|subscriptions) {
    # Stricter rate limiting for payment endpoints
    limit_req zone=auth burst=10 nodelay;

    proxy_pass http://payment_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Tenant-ID $http_x_tenant_id;
    proxy_set_header X-Tenant-Slug $http_x_tenant_slug;
    proxy_set_header X-Request-ID $request_id;

    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Integration Service Routes (/api/v1/integrations/*)
location ~ ^/api/v1/integrations {
    limit_req zone=tenant burst=20 nodelay;

    proxy_pass http://integration_service;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Tenant-ID $http_x_tenant_id;
    proxy_set_header X-Tenant-Slug $http_x_tenant_slug;
    proxy_set_header X-Request-ID $request_id;

    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# File Upload Routes (RustFS - S3-compatible storage)
location ~ ^/api/v1/files {
    # Allow larger requests for file uploads
    client_max_body_size 50M;

    limit_req zone=tenant burst=10 nodelay;

    proxy_pass http://rustfs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Tenant-ID $http_x_tenant_id;
    proxy_set_header Authorization $http_authorization;

    # Disable request buffering for file uploads
    proxy_request_buffering off;
    proxy_http_version 1.1;

    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# Swagger UI (Development only)
location /docs {
    # Only allow in development
    if ($docs_allowed = 0) {
        return 404;
    }

    proxy_pass http://user_service/docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# OpenAPI Spec
location /api-docs {
    proxy_pass http://user_service/api-docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
